<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Record Transaction</title>
<style>
:root{
  --blue:#0d6efd; --blue-600:#0b5ed7; --blue-50:#e7f1ff;
  --ink:#0f172a; --muted:#64748b; --bg:#ffffff; --card:#ffffff;
  --soft:#f1f5f9; --ring:#cfe2ff; --danger:#ef4444; --success:#16a34a;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,"Noto Sans",sans-serif;background:var(--bg);color:var(--ink)}
.container{max-width:900px;margin:0 auto;padding:16px}
header{position:sticky;top:0;background:var(--bg);z-index:10;border-bottom:1px solid #e5e7eb}
.brand{display:flex;align-items:center;gap:12px}
.logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(135deg,var(--blue),#60a5fa);display:grid;place-items:center;color:#fff;font-weight:700}
.card{background:var(--card);border:1px solid #e5e7eb;border-radius:16px;padding:16px;box-shadow:0 1px 2px rgba(0,0,0,.04)}
.controls{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.btn{appearance:none;border:1px solid var(--blue);background:var(--blue);color:#fff;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
.btn.secondary{background:#fff;color:var(--blue)}
.btn.warn{background:var(--danger);border-color:var(--danger)}
.tab{padding:10px 14px;border-radius:10px;border:1px solid #e5e7eb;background:#fff;cursor:pointer;font-weight:600;color:var(--muted)}
.tab.active{background:var(--blue);color:#fff;border-color:var(--blue)}
.grid{display:grid;gap:12px}
.grid-2{grid-template-columns:1fr 1fr}
.input-row{display:grid;grid-template-columns:180px 1fr;align-items:center;border:1.5px solid #e5e7eb;border-radius:12px;padding:8px 10px}
.input-row:focus-within{border-color:var(--blue);box-shadow:0 0 0 4px var(--ring)}
.label{font-size:12px;color:var(--muted)}
.input, .select, .textarea{width:100%;border:none;outline:none;background:transparent;padding:8px 10px;border-radius:8px}
.hint{font-size:12px;color:var(--muted)}
.hidden{display:none}
.right{display:flex;justify-content:flex-end}
.toast{position:fixed;bottom:16px;right:16px;background:#111827;color:#fff;padding:12px 14px;border-radius:12px;opacity:0;transform:translateY(10px);transition:.25s ease;z-index:60}
.toast.show{opacity:1;transform:translateY(0)}
.pane{position:fixed;left:0;right:0;bottom:0;background:#fff;border-top:1px solid #e5e7eb;box-shadow:0 -8px 24px rgba(0,0,0,.06);transform:translateY(105%);transition:.25s ease;z-index:50}
.pane.show{transform:translateY(0)}
.pane .content{max-width:900px;margin:0 auto;padding:12px}
.pane .cols{display:grid;grid-template-columns:220px 1fr;gap:12px}
.list{display:grid;gap:6px;max-height:280px;overflow:auto;border:1px solid #e5e7eb;border-radius:10px;padding:8px}
.list button{width:100%;text-align:left;padding:8px;border:1px solid #e5e7eb;background:#fff;border-radius:8px;cursor:pointer}
.list button.active{background:var(--blue-50);border-color:var(--blue);color:var(--ink)}
.pane-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
</style>
</head>
<body>
<header>
  <div class="container" style="display:flex;align-items:center;justify-content:space-between;gap:12px;padding-block:12px">
    <div class="brand">
      <div class="logo">AB</div>
      <div>
        <div style="font-weight:900">Record Transaction</div>
        <div class="hint">Income • Expense • Transfer</div>
      </div>
    </div>
  </div>
</header>

<main class="container" style="padding-top:18px;padding-bottom:80px">
  <div class="card space-y">
    <div class="controls">
      <button class="tab active" data-type="Income">Income</button>
      <button class="tab" data-type="Expense">Expense</button>
      <button class="tab" data-type="Transfer">Transfer</button>
    </div>

    <div class="grid">
      <!-- Date -->
      <div class="input-row" id="dateRow">
        <div>
          <div class="label">Date</div>
          <div class="hint" id="dateHint"></div>
        </div>
        <input id="date" class="input" placeholder="dd-mm-yyyy" />
      </div>

      <!-- Amount -->
      <div class="input-row">
        <div>
          <div class="label">Amount</div>
          <div class="hint">Can be positive or negative; rounded to 2 decimals</div>
        </div>
        <input id="amount" type="number" step="0.01" class="input" placeholder="0.00" />
      </div>

      <!-- From / Account -->
      <div class="input-row" id="fromRow">
        <div class="label" id="fromLabel">Account</div>
        <div id="fromValue" class="input" tabindex="0" role="button" aria-haspopup="true"></div>
      </div>

      <!-- To Account (Transfer only) -->
      <div class="input-row hidden" id="toRow">
        <div class="label">To Account</div>
        <div id="toValue" class="input" tabindex="0" role="button" aria-haspopup="true"></div>
      </div>

      <!-- Category (Income/Expense only) -->
      <div class="input-row" id="catRow">
        <div class="label">Category</div>
        <div id="catValue" class="input" tabindex="0" role="button" aria-haspopup="true"></div>
      </div>

      <!-- Note -->
      <div class="input-row">
        <div class="label">Note</div>
        <input id="note" class="input" maxlength="120" placeholder="Short note" />
      </div>

      <!-- Description -->
      <div class="input-row">
        <div class="label">Description</div>
        <textarea id="desc" class="input textarea" rows="3" placeholder="Detailed description"></textarea>
      </div>

      <div class="right">
        <button class="btn" id="submitBtn">Submit</button>
      </div>
    </div>
  </div>
</main>

<div id="pickerPane" class="pane" aria-hidden="true">
  <div class="content">
    <div class="pane-head">
      <div><strong id="pickerTitle">Select</strong></div>
      <button class="btn secondary" id="closePane" style="color:var(--blue)">Close</button>
    </div>
    <div class="cols">
      <div class="list" id="groupList"></div>
      <div class="list" id="itemList"></div>
    </div>
  </div>
</div>

<div id="toast" class="toast"></div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbx8QX6s1wU8XDpWqQgFTmVWUolut91hIgivXGqFO_2tm_Ssu6cqWQCBurk238e6O6t0/exec'; // Replace with your Web App URL
let currentType = 'Income';
let ddCache = { accountGroups: [], accounts: [], incomeGroupList: [], incomeCats: [], expenseGroupList: [], expenseCats: [] };

// Toast
function toast(msg, ok=true){
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.background = ok ? '#111827' : '#b91c1c';
  t.classList.add('show');
  setTimeout(()=>t.classList.remove('show'),2200);
}

// API
async function apiGet(params){
  const url = API_URL + '?' + new URLSearchParams(params);
  const res = await fetch(url);
  return res.json();
}
async function apiPost(action, payload){
  const res = await fetch(API_URL,{
    method:'POST',
    headers:{'Content-Type':'text/plain;charset=utf-8'},
    body:JSON.stringify({action, payload})
  });
  return res.json();
}

// Type toggle
document.querySelectorAll('.tab').forEach(b=>{
  b.addEventListener('click',()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    b.classList.add('active');
    currentType = b.dataset.type;
    document.getElementById('fromLabel').textContent = (currentType==='Transfer')? 'From' : 'Account';
    document.getElementById('toRow').classList.toggle('hidden', currentType!=='Transfer');
    document.getElementById('catRow').classList.toggle('hidden', currentType==='Transfer');
  });
});

// Picker
const pane = document.getElementById('pickerPane');
const pickerTitle = document.getElementById('pickerTitle');
const groupList = document.getElementById('groupList');
const itemList = document.getElementById('itemList');
let pickerMode=null, selectedGroup=null;

function openPicker(mode){
  pickerMode=mode;
  pickerTitle.textContent = mode==='cat'? (currentType==='Income'?'Select Income Category':'Select Expense Category') 
                        : (mode==='from'?'Select Account':'Select To Account');
  renderGroups();
  itemList.innerHTML='';
  pane.classList.add('show');
}
function closePicker(){ pane.classList.remove('show'); pickerMode=null; selectedGroup=null; groupList.innerHTML=''; itemList.innerHTML=''; }
document.getElementById('closePane').addEventListener('click', closePicker);

function renderGroups(){
  groupList.innerHTML='';
  let groups=[];
  if(pickerMode==='from'||pickerMode==='to') groups=ddCache.accountGroups.slice();
  else groups=(currentType==='Income'?ddCache.incomeGroupList:ddCache.expenseGroupList).slice();
  groups.filter(Boolean).forEach(g=>{
    const btn=document.createElement('button');
    btn.textContent=g;
    btn.addEventListener('click',()=>{
      selectedGroup=g; renderItems();
      groupList.querySelectorAll('button').forEach(x=>x.classList.toggle('active',x.textContent===g));
    });
    groupList.appendChild(btn);
  });
}
function renderItems(){
  itemList.innerHTML='';
  let items=[];
  if(pickerMode==='from'||pickerMode==='to') items=ddCache.accounts.filter(a=>a.group===selectedGroup).map(a=>a.name);
  else items=(currentType==='Income'?ddCache.incomeCats:ddCache.expenseCats).filter(c=>c.group===selectedGroup).map(c=>c.name);
  items.forEach(name=>{
    const btn=document.createElement('button');
    btn.textContent=name;
    btn.addEventListener('click',()=>{
      if(pickerMode==='from') document.getElementById('fromValue').textContent=name;
      else if(pickerMode==='to') document.getElementById('toValue').textContent=name;
      else document.getElementById('catValue').textContent=name;
      closePicker();
    });
    itemList.appendChild(btn);
  });
}

// Open pickers
document.getElementById('fromRow').addEventListener('click',()=>openPicker('from'));
document.getElementById('toRow').addEventListener('click',()=>openPicker('to'));
document.getElementById('catRow').addEventListener('click',()=>openPicker('cat'));

// Amount rounding
document.getElementById('amount').addEventListener('blur',()=>{
  const v=Number(document.getElementById('amount').value);
  if(Number.isFinite(v)) document.getElementById('amount').value=(Math.round(v*100)/100).toFixed(2);
  else document.getElementById('amount').value='';
});

// Load dropdowns (replace with your Apps Script API)
async function loadDropdowns(){
  try{
    const { data: dd } = await apiGet({action:'getDropdowns'});
    ddCache=dd;
  }catch(e){console.error(e); toast('Failed to load dropdowns', false);}
}

// Submit
document.getElementById('submitBtn').addEventListener('click', async()=>{
  const date=document.getElementById('date').value.trim();
  const amount=Number(document.getElementById('amount').value);
  const fromAccount=document.getElementById('fromValue').textContent.trim();
  const toAccount=document.getElementById('toValue').textContent.trim();
  const category=document.getElementById('catValue').textContent.trim();
  if(!date){toast('Enter date', false); return;}
  if(!Number.isFinite(amount) || amount===0){toast('Enter valid amount', false); return;}
  if(!fromAccount){toast('Select account', false); return;}
  if(currentType==='Transfer' && !toAccount){toast('Select To Account', false); return;}
  if(currentType!=='Transfer' && !category){toast('Select category', false); return;}
  const payload={type:currentType, date, amount, fromAccount, toAccount, category, note:document.getElementById('note').value||'', desc:document.getElementById('desc').value||''};
  try{
    document.getElementById('submitBtn').disabled=true;
    const res=await apiPost('postTx', payload);
    if(res.ok){toast('Posted',true); document.getElementById('amount').value=''; document.getElementById('note').value=''; document.getElementById('desc').value='';}
    else throw new Error('Post failed');
  }catch(e){console.error(e); toast('Post failed', false);}
  finally{document.getElementById('submitBtn').disabled=false;}
});

// Init
(async function init(){await loadDropdowns();})();
</script>
</body>
</html>



